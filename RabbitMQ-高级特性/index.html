



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="失心耀的博客" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="失心耀的博客" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="失心耀的博客" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="RabbitMQ" />


<link rel="canonical" href="http://example.com/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">



  <title>
RabbitMQ 高级特性 - Rabbitmq - 后端 - 计算机学习 |
zxy Shoka = 失心耀的博客</title>
<meta name="generator" content="Hexo 5.4.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">RabbitMQ 高级特性
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2021-05-10 11:38:04">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2021-05-10T11:38:04+08:00">2021-05-10</time>
  </span>
  <span class="item" title="本文字数">
    <span class="icon">
      <i class="ic i-pen"></i>
    </span>
    <span class="text">本文字数</span>
    <span>29k</span>
    <span class="text">字</span>
  </span>
  <span class="item" title="阅读时长">
    <span class="icon">
      <i class="ic i-clock"></i>
    </span>
    <span class="text">阅读时长</span>
    <span>27 分钟</span>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">zxy Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicitzannuj20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclwrdwyaj20zk0m8are.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicis081o9j20zk0m8dmr.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclgrvbd6j20zk0m8qv5.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipeuv80yoj20zk0m8kjl.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giph4lm9i7j20zk0m84qp.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span><i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/skill/" itemprop="item" rel="index" title="分类于 计算机学习"><span itemprop="name">计算机学习</span></a>
<meta itemprop="position" content="1" /></span>
<i class="ic i-angle-right"></i>
<span  itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/skill/%E5%90%8E%E7%AB%AF/" itemprop="item" rel="index" title="分类于 后端"><span itemprop="name">后端</span></a>
<meta itemprop="position" content="2" /></span>
<i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/skill/%E5%90%8E%E7%AB%AF/Rabbitmq/" itemprop="item" rel="index" title="分类于 Rabbitmq"><span itemprop="name">Rabbitmq</span></a>
<meta itemprop="position" content="3" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://example.com/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="失心耀">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="失心耀的博客">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <span id="more"></span>
<h1 id="1-rabbitmq高级-过期时间ttl"><a class="markdownIt-Anchor" href="#1-rabbitmq高级-过期时间ttl">#</a> 1. RabbitMQ 高级 - 过期时间 TTL</h1>
<h2 id="11-概述"><a class="markdownIt-Anchor" href="#11-概述">#</a> 1.1 概述</h2>
<p>过期时间 TTL 表示可以对消息设置预期的时间，在这个时间内都可以被消费者接收获取；过了之后消息将自动被删除。RabbitMQ 可以对<strong>消息和队列</strong>设置 TTL。目前有两种方法可以设置。</p>
<ul>
<li>第一种方法是通过队列属性设置，队列中所有消息都有相同的过期时间。</li>
<li>第二种方法是对消息进行单独设置，每条消息 TTL 可以不同。</li>
</ul>
<p><strong>如果上述两种方法同时使用</strong>，<strong>则消息的过期时间以两者之间 TTL 较小的那个数值为准</strong>。消息在队列的生存时间一旦超过设置的 TTL 值，就称为 dead message 被投递到死信队列， 消费者将无法再收到该消息。</p>
<h2 id="12-设置队列ttl"><a class="markdownIt-Anchor" href="#12-设置队列ttl">#</a> 1.2 设置队列 TTL</h2>
<p>生产者、消费者都进行交换机、队列的配置</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @ClassName TTLRabbitMqConfiguration</pre></td></tr><tr><td data-num="3"></td><td><pre> * @Description ttl 队列配置</pre></td></tr><tr><td data-num="4"></td><td><pre> * @Author zzm</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Data 2021/5/13 16:40</pre></td></tr><tr><td data-num="6"></td><td><pre> * @Version 1.0</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TTLRabbitMqConfiguration</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 声明注册 direct 模式的交换机</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">DirectExchange</span> <span class="token function">ttlDirectExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token string">"ttl_direct_exchange"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">ttlQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 队列的过期时间</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-message-ttl"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"ttl.direct.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">ttlDirectBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">ttlQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">ttlDirectExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">"ttl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote>
<p>参数 x-message-ttl 的值 必须是非负 32 位整数 (0 &lt;= n &lt;= 2^32-1) ，以毫秒为单位表示 TTL 的值。这样，值 6000 表示存在于 队列 中的当前 消息 将最多只存活 6 秒。</p>
</blockquote>
<p>生产者 <code>OrderService</code>  下单代码，以及测试。</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">makeOrderTTL</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> productId<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token comment">// 定义交换机</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"ttl_direct_exchange"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">String</span> orderNumber <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户 "</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">",订单编号是："</span> <span class="token operator">+</span> orderNumber<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">String</span> routingKey <span class="token operator">=</span> <span class="token string">"ttl"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token comment">// 发送订单信息给 RabbitMQ fanout</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> orderNumber<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">testTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    orderService<span class="token punctuation">.</span><span class="token function">makeOrderTTL</span><span class="token punctuation">(</span><span class="token number">111L</span><span class="token punctuation">,</span> <span class="token number">222L</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513165521887.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513165521887.png" class=""></p>
<h2 id="13-设置消息ttl"><a class="markdownIt-Anchor" href="#13-设置消息ttl">#</a> 1.3 设置消息 TTL</h2>
<p>消息的过期时间；只需要在发送消息（可以发送到任何队列，不管该队列是否属于某个交换机）的时候设置过期时间即可。在测试类中编写如下方法发送消息并设置过期时间到队列：</p>
<ul>
<li>在 <code>TTLRabbitMqConfiguration</code>  配置类中创建一个普通的队列，并绑定到该交换机上。</li>
</ul>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">ttlMsgQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"ttl.message.direct.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul>
<li>在生产者 <code>OrderService</code>  中发送消息，并设置过期时间。</li>
</ul>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">// 给消息设置过期时间</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">makeOrderTTLMsg</span><span class="token punctuation">(</span><span class="token class-name">Long</span> userId<span class="token punctuation">,</span> <span class="token class-name">Long</span> productId<span class="token punctuation">,</span> <span class="token keyword">int</span> num<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment">// 定义交换机</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">String</span> exchangeName <span class="token operator">=</span> <span class="token string">"ttl_direct_exchange"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">String</span> orderNumber <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"用户 "</span> <span class="token operator">+</span> userId <span class="token operator">+</span> <span class="token string">",订单编号是："</span> <span class="token operator">+</span> orderNumber<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token class-name">String</span> routingKey <span class="token operator">=</span> <span class="token string">"ttlMsg"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">// 给消息设置过期时间</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token class-name">MessagePostProcessor</span> messagePostProcessor <span class="token operator">=</span> message <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExpiration</span><span class="token punctuation">(</span><span class="token string">"5000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        message<span class="token punctuation">.</span><span class="token function">getMessageProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContentEncoding</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">return</span> message<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 发送订单信息给 RabbitMQ fanout</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span>exchangeName<span class="token punctuation">,</span> routingKey<span class="token punctuation">,</span> orderNumber<span class="token punctuation">,</span> messagePostProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">testTTLMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    orderService<span class="token punctuation">.</span><span class="token function">makeOrderTTLMsg</span><span class="token punctuation">(</span><span class="token number">111L</span><span class="token punctuation">,</span> <span class="token number">222L</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote>
<p>两种方法有如下区别：</p>
<p>队列 TTL：过期以后，会写入转移到死信队列中。</p>
<p>消息 TTL：过期以后，就会被移除，不会被转移到死信队列中。</p>
</blockquote>
<h1 id="2-rabbitmq高级-死信队列"><a class="markdownIt-Anchor" href="#2-rabbitmq高级-死信队列">#</a> 2. RabbitMQ 高级 - 死信队列</h1>
<h2 id="21-概述"><a class="markdownIt-Anchor" href="#21-概述">#</a> 2.1 概述</h2>
<p>DLX，全称为 Dead-Letter-Exchange , 可以称之为死信交换机，也有人称之为死信邮箱。当消息在一个队列中变成死信 (dead message) 之后，它能被重新发送到另一个交换机中，这个交换机就是 DLX ，绑定 DLX 的队列就称之为死信队列。<br>
消息变成死信，可能是由于以下的原因：</p>
<ul>
<li>消息被拒绝</li>
<li>消息过期</li>
<li>队列达到最大长度</li>
</ul>
<p>DLX 也是一个正常的交换机，和一般的交换机没有区别，它能在任何的队列上被指定，实际上就是设置某一个队列的属性。<strong>当这个队列中存在死信时，Rabbitmq 就会自动地将这个消息重新发布到设置的 DLX 上去，进而被路由到另一个队列，即死信队列。</strong><br>
要想使用死信队列，只需要在定义队列的时候设置队列参数  <code>x-dead-letter-exchange</code>  指定交换机即可。</p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/833.png" alt=""></p>
<img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/833.png" class="">
<h2 id="22-实现"><a class="markdownIt-Anchor" href="#22-实现">#</a> 2.2 实现</h2>
<p>在 <code>TTLRabbitMqConfiguration</code>  中的队列 <code>ttlQueue</code>  配置死信交换机和死信队列</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">ttlQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 队列的过期时间</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-message-ttl"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 设置死信交换机和死信队列</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-exchange"</span><span class="token punctuation">,</span> <span class="token string">"dead_direct_exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-routing-key"</span><span class="token punctuation">,</span> <span class="token string">"dead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//fanout 模式不需要配置路由 Key</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"ttl.direct.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>然后再运行下之前的测试方法</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token keyword">void</span> <span class="token function">testTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>        orderService<span class="token punctuation">.</span><span class="token function">makeOrderTTL</span><span class="token punctuation">(</span><span class="token number">111L</span><span class="token punctuation">,</span> <span class="token number">222L</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 rabbitMQ 管理界面中结果</p>
<ul>
<li>未过期：</li>
</ul>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513173952448.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513173952448.png" class=""></p>
<ul>
<li>过期后：</li>
</ul>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513174028982.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513174028982.png" class=""></p>
<h2 id="23-队列达到最大接收长度"><a class="markdownIt-Anchor" href="#23-队列达到最大接收长度">#</a> 2.3 队列达到最大接收长度</h2>
<p>在 <code>TTLRabbitMqConfiguration</code>  中的队列 <code>ttlQueue</code>  配置接收消息个数</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">ttlQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">// 队列的过期时间</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-message-ttl"</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 设置死信交换机和死信队列</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-exchange"</span><span class="token punctuation">,</span> <span class="token string">"dead_direct_exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-routing-key"</span><span class="token punctuation">,</span> <span class="token string">"dead"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//fanout 模式不需要配置路由 Key</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"ttl.direct.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>如果达到最大接收消息个数后，其余的消息会被转移到死信队列中。</p>
<p>模拟发送 11 次消息到该队列中</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">testForTTL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>        orderService<span class="token punctuation">.</span><span class="token function">makeOrderTTL</span><span class="token punctuation">(</span><span class="token number">111L</span><span class="token punctuation">,</span> <span class="token number">222L</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513175005152.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513175005152.png" class=""></p>
<p>该队列只能接收 5 个消息，其余的 6 个转移到死信队列中。</p>
<p>ttl 队列的 5 个消息过期后，也会被转入死信队列中。</p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513175130713.png" alt="image-20210513175130713"></p>
<img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210513175130713.png" class="">
<h1 id="3rabbitmq高级-内存磁盘的监控"><a class="markdownIt-Anchor" href="#3rabbitmq高级-内存磁盘的监控">#</a> 3.RabbitMQ 高级 - 内存磁盘的监控</h1>
<h2 id="31-rabbitmq的内存警告"><a class="markdownIt-Anchor" href="#31-rabbitmq的内存警告">#</a> 3.1 RabbitMQ 的内存警告</h2>
<p>当内存使用超过配置的阈值或者磁盘空间剩余空间对于配置的阈值时，RabbitMQ 会暂时阻塞客户端的连接，并且停止接收从客户端发来的消息，以此避免服务器的崩溃，客户端与服务端的心态检测机制也会失效。<br>
如下图：</p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/840.png" alt=""></p>
<img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/840.png" class="">
<p><strong>当出现 blocking 或 blocked 话说明到达了阈值和以及高负荷运行了。</strong></p>
<h2 id="32-rabbitmq的内存控制"><a class="markdownIt-Anchor" href="#32-rabbitmq的内存控制">#</a> 3.2 RabbitMQ 的内存控制</h2>
<p>参考帮助文档：<span class="exturl" data-url="aHR0cHM6Ly93d3cucmFiYml0bXEuY29tL2NvbmZpZ3VyZS5odG1s">https://www.rabbitmq.com/configure.html</span><br>
 当出现警告的时候，可以通过配置去修改和调整.</p>
<h3 id="321-命令的方式"><a class="markdownIt-Anchor" href="#321-命令的方式">#</a> 3.2.1 命令的方式：</h3>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rabbitmqctl set_vm_memory_high_watermark <span class="token number">0.7</span> <span class="token comment">#设置相对的内存大小，值的范围在 0~1 范围，是磁盘大小的 0~1 倍数，建议取值在 04~0.7 之间，不建议超过 0.7.</span></pre></td></tr><tr><td data-num="2"></td><td><pre>rabbitmqctl set_vm_memory_high_watermark absolute 10MB <span class="token comment">#设置绝对的内存大小</span></pre></td></tr></table></figure><p><strong>fraction/value 为内存阈值</strong>。<strong>默认情况是：0.4/2GB</strong>，代表的含义是：当 RabbitMQ 的内存超过 40% 时，就会产生警告并且阻塞所有生产者的连接。通过此命令修改阈值在 Broker 重启以后将会失效，通过修改配置文件方式设置的阈值则不会随着重启而消失，但修改了配置文件一样要重启 broker 才会生效。</p>
<p>分析：</p>
<blockquote>
<p>rabbitmqctl set_vm_memory_high_watermark absolute 50MB</p>
</blockquote>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/841.png" alt=""></p>
<img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/841.png" class="">
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/842.png" alt=""></p>
<img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/842.png" class="">
<p>看到 <code>State</code>  为 <code>blocking</code> ，赶紧给 Rabbitmq 加内存。</p>
<h3 id="322-配置文件方式-rabbitmqconf"><a class="markdownIt-Anchor" href="#322-配置文件方式-rabbitmqconf">#</a> 3.2.2 配置文件方式 rabbitmq.conf</h3>
<blockquote>
<p>当前配置文件：/etc/rabbitmq/rabbitmq.conf</p>
</blockquote>
<figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#默认</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">#vm_memory_high_watermark.relative = 0.4</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 使用 relative 相对值进行设置 fraction, 建议取值在 04~0.7 之间，不建议超过 0.7.</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token attr-name">vm_memory_high_watermark.relative</span> <span class="token punctuation">=</span> <span class="token attr-value">0.6</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 使用 absolute 的绝对值的方式，但是是 KB,MB,GB 对应的命令如下</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token attr-name">vm_memory_high_watermark.absolute</span> <span class="token punctuation">=</span> <span class="token attr-value">2GB</span></pre></td></tr></table></figure><h2 id="33-rabbitmq的内存换页"><a class="markdownIt-Anchor" href="#33-rabbitmq的内存换页">#</a> 3.3 RabbitMQ 的内存换页</h2>
<p>在某个 Broker 节点及内存阻塞生产者之前，它会尝试将队列中的消息换页到磁盘以释放内存空间，持久化和非持久化的消息都会写入磁盘中，其中持久化的消息本身就在磁盘中有一个副本，所以在转移的过程中持久化的消息会先从内存中清除掉。</p>
<blockquote>
<p><strong>默认情况下，内存到达的阈值是 50% 时就会换页处理。</strong><br>
也就是说，在默认情况下该内存的阈值是 0.4 的情况下，当内存超过 0.4*0.5=0.2 时，会进行换页动作。</p>
</blockquote>
<p>比如有 1000MB 内存，当内存的使用率达到了 400MB, 已经达到了极限，但是因为配置的换页内存 0.5，这个时候会在达到极限 400mb 之前，会把内存中的 200MB 进行转移到磁盘中。从而达到稳健的运行。</p>
<p>可以通过设置  <code>vm_memory_high_watermark_paging_ratio</code>  来进行调整</p>
<figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">vm_memory_high_watermark.relative</span> <span class="token punctuation">=</span> <span class="token attr-value">0.4</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">vm_memory_high_watermark_paging_ratio</span> <span class="token punctuation">=</span> <span class="token attr-value">0.7 #建议小于0。7，最好是在0.4或者0.5（设置小于1的值）</span></pre></td></tr></table></figure><p>为什么设置小</p>
<p>于 1，以为你如果你设置为 1 的阈值。内存都已经达到了极限了。你在去换页意义不是很大了。</p>
<h2 id="34-rabbitmq的磁盘预警"><a class="markdownIt-Anchor" href="#34-rabbitmq的磁盘预警">#</a> 3.4 RabbitMQ 的磁盘预警</h2>
<p>当磁盘的剩余空间低于确定的阈值时，RabbitMQ 同样会阻塞生产者，这样可以避免因非持久化的消息持续换页而耗尽磁盘空间导致服务器崩溃。</p>
<blockquote>
<p>** 默认情况下：磁盘预警为 50MB 的时候会进行预警。** 表示当前磁盘空间第 50MB 的时候会阻塞生产者并且停止内存消息换页到磁盘的过程。<br>
这个阈值可以减小，但是不能完全的消除因磁盘耗尽而导致崩溃的可能性。比如在两次磁盘空间的检查空隙内，第一次检查是：60MB ，第二检查可能就是 1MB, 就会出现警告。</p>
</blockquote>
<h3 id="通过命令方式修改如下"><a class="markdownIt-Anchor" href="#通过命令方式修改如下">#</a> 通过命令方式修改如下：</h3>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rabbitmqctl set_disk_free_limit  <span class="token operator">&lt;</span>disk_limit<span class="token operator">></span></pre></td></tr><tr><td data-num="2"></td><td><pre>rabbitmqctl set_disk_free_limit mem_relative  <span class="token operator">&lt;</span>fraction<span class="token operator">></span></pre></td></tr><tr><td data-num="3"></td><td><pre>disk_limit：固定单位 KB MB GB</pre></td></tr><tr><td data-num="4"></td><td><pre>fraction ：是相对阈值，建议范围在:1.0~2.0之间。（相对于内存）</pre></td></tr></table></figure><h3 id="通过配置文件配置如下"><a class="markdownIt-Anchor" href="#通过配置文件配置如下">#</a> 通过配置文件配置如下：</h3>
<figure class="highlight properties"><figcaption data-lang=".properties"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token attr-name">disk_free_limit.relative</span> <span class="token punctuation">=</span> <span class="token attr-value">3.0</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token attr-name">disk_free_limit.absolute</span> <span class="token punctuation">=</span> <span class="token attr-value">50mb</span></pre></td></tr></table></figure><h1 id="4-rabbitmq-高级-集群"><a class="markdownIt-Anchor" href="#4-rabbitmq-高级-集群">#</a> 4. RabbitMQ - 高级 - 集群</h1>
<h2 id="41-rabbitmq-集群"><a class="markdownIt-Anchor" href="#41-rabbitmq-集群">#</a> 4.1 RabbitMQ 集群</h2>
<p>RabbitMQ 这款消息队列中间件产品本身是基于 Erlang 编写，Erlang 语言天生具备分布式特性（通过同步 Erlang 集群各节点的 magic cookie 来实现）。因此，RabbitMQ 天然支持 Clustering。这使得 RabbitMQ 本身不需要像 ActiveMQ、Kafka 那样通过 ZooKeeper 分别来实现 HA 方案和保存集群的元数据。集群是保证可靠性的一种方式，同时可以通过水平扩展以达到增加消息吞吐量能力的目的。<br>
在实际使用过程中多采取多机多实例部署方式，为了便于同学们练习搭建，有时候你不得不在一台机器上去搭建一个 rabbitmq 集群，本章主要针对单机多实例这种方式来进行开展。</p>
<blockquote>
<p>主要参考官方文档：<span class="exturl" data-url="aHR0cHM6Ly93d3cucmFiYml0bXEuY29tL2NsdXN0ZXJpbmcuaHRtbA==">https://www.rabbitmq.com/clustering.html</span></p>
</blockquote>
<h2 id="42-集群搭建"><a class="markdownIt-Anchor" href="#42-集群搭建">#</a> 4.2 集群搭建</h2>
<p>配置的前提是你的 rabbitmq 可以运行起来，比如”ps aux|grep rabbitmq” 你能看到相关进程，又比如运行 “rabbitmqctl status” 你可以看到类似如下信息，而不报错：</p>
<p>执行下面命令进行查看：</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">ps</span> aux<span class="token operator">|</span><span class="token function">grep</span> rabbitmq</pre></td></tr></table></figure><p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210518185635235.png" alt=""></p>
<img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/image-20210518185635235.png" class="">
<p>或者</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>systemctl status rabbitmq-server</pre></td></tr></table></figure><blockquote>
<p>注意：确保 RabbitMQ 可以运行的，确保完成之后，把单机版的 RabbitMQ 服务停止，后台看不到 RabbitMQ 的进程为止</p>
</blockquote>
<h2 id="43-单机多实例搭建"><a class="markdownIt-Anchor" href="#43-单机多实例搭建">#</a> 4.3 单机多实例搭建</h2>
<p>** 场景：** 假设有两个 rabbitmq 节点，分别为 rabbit-1, rabbit-2，rabbit-1 作为主节点，rabbit-2 作为从节点。<br>
<strong>启动命令</strong>：RABBITMQ_NODE_PORT=5672 RABBITMQ_NODENAME=rabbit-1 rabbitmq-server -detached<br>
<strong> 结束命令</strong>：rabbitmqctl -n rabbit-1 stop</p>
<h3 id="431-第一步启动第一个节点rabbit-1"><a class="markdownIt-Anchor" href="#431-第一步启动第一个节点rabbit-1">#</a> 4.3.1 <strong>第一步</strong>：启动第一个节点 rabbit-1</h3>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> <span class="token assign-left variable">RABBITMQ_NODE_PORT</span><span class="token operator">=</span><span class="token number">5672</span> <span class="token assign-left variable">RABBITMQ_NODENAME</span><span class="token operator">=</span>rabbit-1 rabbitmq-server start <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.省略<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">##########  Logs: /var/log/rabbitmq/rabbit-1.log</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">######  ##        /var/log/rabbitmq/rabbit-1-sasl.log</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">##########</span></pre></td></tr><tr><td data-num="6"></td><td><pre>              Starting broker<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="7"></td><td><pre> completed with <span class="token number">7</span> plugins.</pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token number">1234567</span></pre></td></tr></table></figure><p>至此节点 rabbit-1 启动完成。</p>
<h3 id="432-启动第二个节点rabbit-2"><a class="markdownIt-Anchor" href="#432-启动第二个节点rabbit-2">#</a> 4.3.2 启动第二个节点 rabbit-2</h3>
<blockquote>
<p>注意：web 管理插件端口占用，所以还要指定其 web 插件占用的端口号<br>
 RABBITMQ_SERVER_START_ARGS=”-rabbitmq_management listener [{port,15673}]”</p>
</blockquote>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">sudo</span> <span class="token assign-left variable">RABBITMQ_NODE_PORT</span><span class="token operator">=</span><span class="token number">5673</span> <span class="token assign-left variable">RABBITMQ_SERVER_START_ARGS</span><span class="token operator">=</span><span class="token string">"-rabbitmq_management listener [&#123;port,15673&#125;]"</span> <span class="token assign-left variable">RABBITMQ_NODENAME</span><span class="token operator">=</span>rabbit-2 rabbitmq-server start <span class="token operator">&amp;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>省略<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span></pre></td></tr><tr><td data-num="3"></td><td><pre>  <span class="token comment">##########  Logs: /var/log/rabbitmq/rabbit-2.log</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">######  ##        /var/log/rabbitmq/rabbit-2-sasl.log</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token comment">##########</span></pre></td></tr><tr><td data-num="6"></td><td><pre>              Starting broker<span class="token punctuation">..</span>.</pre></td></tr><tr><td data-num="7"></td><td><pre> completed with <span class="token number">7</span> plugins.</pre></td></tr></table></figure><p>至此节点 rabbit-2 启动完成</p>
<h3 id="433-验证启动-ps-auxgrep-rabbitmq"><a class="markdownIt-Anchor" href="#433-验证启动-ps-auxgrep-rabbitmq">#</a> 4.3.3 验证启动 “ps aux|grep rabbitmq”</h3>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rabbitmq  <span class="token number">2022</span>  <span class="token number">2.7</span>  <span class="token number">0.4</span> <span class="token number">5349380</span> <span class="token number">77020</span> ?       Sl   <span class="token number">11</span>:03   <span class="token number">0</span>:06 /usr/lib/erlang/erts-9.2/bin/beam.smp -W w -A <span class="token number">128</span> -P <span class="token number">1048576</span> -t <span class="token number">5000000</span> -stbt db -zdbbl <span class="token number">128000</span> -K <span class="token boolean">true</span> -B i -- -root /usr/lib/erlang -progname erl -- -home /var/lib/rabbitmq -- -pa /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/ebin -noshell -noinput -s rabbit boot -sname rabbit-1 -boot start_sasl -kernel inet_default_connect_options <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>nodelay,true<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> -rabbit tcp_listeners <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"auto"</span>,5672<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> -sasl errlog_type error -sasl sasl_error_logger <span class="token boolean">false</span> -rabbit error_logger <span class="token punctuation">&#123;</span>file,<span class="token string">"/var/log/rabbitmq/rabbit-1.log"</span><span class="token punctuation">&#125;</span> -rabbit sasl_error_logger <span class="token punctuation">&#123;</span>file,<span class="token string">"/var/log/rabbitmq/rabbit-1-sasl.log"</span><span class="token punctuation">&#125;</span> -rabbit enabled_plugins_file <span class="token string">"/etc/rabbitmq/enabled_plugins"</span> -rabbit plugins_dir <span class="token string">"/usr/lib/rabbitmq/plugins:/usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/plugins"</span> -rabbit plugins_expand_dir <span class="token string">"/var/lib/rabbitmq/mnesia/rabbit-1-plugins-expand"</span> -os_mon start_cpu_sup <span class="token boolean">false</span> -os_mon start_disksup <span class="token boolean">false</span> -os_mon start_memsup <span class="token boolean">false</span> -mnesia <span class="token function">dir</span> <span class="token string">"/var/lib/rabbitmq/mnesia/rabbit-1"</span> -kernel inet_dist_listen_min <span class="token number">25672</span> -kernel inet_dist_listen_max <span class="token number">25672</span> start</pre></td></tr><tr><td data-num="2"></td><td><pre>rabbitmq  <span class="token number">2402</span>  <span class="token number">4.2</span>  <span class="token number">0.4</span> <span class="token number">5352196</span> <span class="token number">77196</span> ?       Sl   <span class="token number">11</span>:05   <span class="token number">0</span>:05 /usr/lib/erlang/erts-9.2/bin/beam.smp -W w -A <span class="token number">128</span> -P <span class="token number">1048576</span> -t <span class="token number">5000000</span> -stbt db -zdbbl <span class="token number">128000</span> -K <span class="token boolean">true</span> -B i -- -root /usr/lib/erlang -progname erl -- -home /var/lib/rabbitmq -- -pa /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/ebin -noshell -noinput -s rabbit boot -sname rabbit-2 -boot start_sasl -kernel inet_default_connect_options <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>nodelay,true<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> -rabbit tcp_listeners <span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">"auto"</span>,5673<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> -sasl errlog_type error -sasl sasl_error_logger <span class="token boolean">false</span> -rabbit error_logger <span class="token punctuation">&#123;</span>file,<span class="token string">"/var/log/rabbitmq/rabbit-2.log"</span><span class="token punctuation">&#125;</span> -rabbit sasl_error_logger <span class="token punctuation">&#123;</span>file,<span class="token string">"/var/log/rabbitmq/rabbit-2-sasl.log"</span><span class="token punctuation">&#125;</span> -rabbit enabled_plugins_file <span class="token string">"/etc/rabbitmq/enabled_plugins"</span> -rabbit plugins_dir <span class="token string">"/usr/lib/rabbitmq/plugins:/usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/plugins"</span> -rabbit plugins_expand_dir <span class="token string">"/var/lib/rabbitmq/mnesia/rabbit-2-plugins-expand"</span> -os_mon start_cpu_sup <span class="token boolean">false</span> -os_mon start_disksup <span class="token boolean">false</span> -os_mon start_memsup <span class="token boolean">false</span> -mnesia <span class="token function">dir</span> <span class="token string">"/var/lib/rabbitmq/mnesia/rabbit-2"</span> -rabbitmq_management listener <span class="token punctuation">[</span><span class="token punctuation">&#123;</span>port,15673<span class="token punctuation">&#125;</span><span class="token punctuation">]</span> -kernel inet_dist_listen_min <span class="token number">25673</span> -kernel inet_dist_listen_max <span class="token number">25673</span> start</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token number">12</span></pre></td></tr></table></figure><h3 id="434-rabbit-1操作作为主节点"><a class="markdownIt-Anchor" href="#434-rabbit-1操作作为主节点">#</a> 4.3.4 rabbit-1 操作作为主节点</h3>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#停止应用</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> rabbitmqctl -n rabbit-1 stop_app</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#目的是清除节点上的历史数据（如果不清除，无法将节点加入到集群）</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> rabbitmqctl -n rabbit-1 reset</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#启动应用</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> rabbitmqctl -n rabbit-1 start_app</pre></td></tr></table></figure><h3 id="435-rabbit2操作为从节点"><a class="markdownIt-Anchor" href="#435-rabbit2操作为从节点">#</a> 4.3.5 rabbit2 操作为从节点</h3>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># 停止应用</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> rabbitmqctl -n rabbit-2 stop_app</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment"># 目的是清除节点上的历史数据（如果不清除，无法将节点加入到集群）</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> rabbitmqctl -n rabbit-2 reset</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment"># 将 rabbit2 节点加入到 rabbit1（主节点）集群当中【Server-node 服务器的主机名】</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> rabbitmqctl -n rabbit-2 join_cluster rabbit-1@<span class="token string">'Server-node'</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># 启动应用</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> rabbitmqctl -n rabbit-2 start_app</pre></td></tr></table></figure><h3 id="436-验证集群状态"><a class="markdownIt-Anchor" href="#436-验证集群状态">#</a> 4.3.6 验证集群状态</h3>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token operator">></span> <span class="token function">sudo</span> rabbitmqctl cluster_status -n rabbit-1</pre></td></tr><tr><td data-num="2"></td><td><pre>//集群有两个节点：rabbit-1@Server-node、rabbit-2@Server-node</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">[</span><span class="token punctuation">&#123;</span>nodes,<span class="token punctuation">[</span><span class="token punctuation">&#123;</span>disc,<span class="token punctuation">[</span><span class="token string">'rabbit-1@Server-node'</span>,<span class="token string">'rabbit-2@Server-node'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="4"></td><td><pre> <span class="token punctuation">&#123;</span>running_nodes,<span class="token punctuation">[</span><span class="token string">'rabbit-2@Server-node'</span>,<span class="token string">'rabbit-1@Server-node'</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="5"></td><td><pre> <span class="token punctuation">&#123;</span>cluster_name,<span class="token operator">&lt;&lt;</span><span class="token string">"rabbit-1@Server-node.localdomain"</span><span class="token operator">>></span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="6"></td><td><pre> <span class="token punctuation">&#123;</span>partitions,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>,</pre></td></tr><tr><td data-num="7"></td><td><pre> <span class="token punctuation">&#123;</span>alarms,<span class="token punctuation">[</span><span class="token punctuation">&#123;</span><span class="token string">'rabbit-2@Server-node'</span>,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span>,<span class="token punctuation">&#123;</span><span class="token string">'rabbit-1@Server-node'</span>,<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span><span class="token punctuation">&#125;</span><span class="token punctuation">]</span></pre></td></tr></table></figure><h3 id="437-web监控"><a class="markdownIt-Anchor" href="#437-web监控">#</a> 4.3.7 Web 监控</h3>
<blockquote>
<p>打开 rabbitmq Web 管理界面：rabbitmq-plugins enable rabbitmq_management</p>
</blockquote>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/851.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/851.png" class=""></p>
<img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/851.png" class="">
<blockquote>
<p>注意在访问的时候：web 结面的管理需要给 15672 node-1 和 15673 的 node-2 设置用户名和密码。如下:</p>
</blockquote>
<p>在 <code>rabbit-1</code>  或者 <code>rabbit-2</code>  其中一个节点设置的用户，其他节点都会共享。</p>
<figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>rabbitmqctl -n rabbit-1 add_user admin admin</pre></td></tr><tr><td data-num="2"></td><td><pre>rabbitmqctl -n rabbit-1 set_user_tags admin administrator</pre></td></tr><tr><td data-num="3"></td><td><pre>rabbitmqctl -n rabbit-1 set_permissions -p / admin <span class="token string">".*"</span> <span class="token string">".*"</span> <span class="token string">".*"</span></pre></td></tr><tr><td data-num="4"></td><td><pre>rabbitmqctl -n rabbit-2 add_user admin admin</pre></td></tr><tr><td data-num="5"></td><td><pre>rabbitmqctl -n rabbit-2 set_user_tags admin administrator</pre></td></tr><tr><td data-num="6"></td><td><pre>rabbitmqctl -n rabbit-2 set_permissions -p / admin <span class="token string">".*"</span> <span class="token string">".*"</span> <span class="token string">".*"</span></pre></td></tr></table></figure><h3 id="438-小结"><a class="markdownIt-Anchor" href="#438-小结">#</a> 4.3.8 小结</h3>
<blockquote>
<p><strong>Tips：</strong><br>
如果采用多机部署方式，需读取其中一个节点的 cookie, 并复制到其他节点（节点之间通过 cookie 确定相互是否可通信）。cookie 存放在 /var/lib/rabbitmq/.erlang.cookie。<br>
例如：主机名分别为 rabbit-1、rabbit-2<br>
1、逐个启动各节点<br>
 2、配置各节点的 hosts 文件 (vim /etc/hosts)<br>
​ ip1：rabbit-1<br>
​ ip2：rabbit-2<br>
 其它步骤雷同单机部署方式</p>
</blockquote>
<h1 id="5-rabbitmq-高级-分布式事务"><a class="markdownIt-Anchor" href="#5-rabbitmq-高级-分布式事务">#</a> 5. RabbitMQ - 高级 - 分布式事务</h1>
<h2 id="51-简述"><a class="markdownIt-Anchor" href="#51-简述">#</a> 5.1 简述</h2>
<p>分布式事务指事务的操作位于不同的节点上，需要保证事务的 AICD 特性。<br>
例如在下单场景下，库存和订单如果不在同一个节点上，就涉及分布式事务。</p>
<blockquote>
<p>简单的说，就是在某个业务处理下，所涉及到的多个系统之间各自数据库的数据一致性。</p>
</blockquote>
<h2 id="52-分布式事务的方式"><a class="markdownIt-Anchor" href="#52-分布式事务的方式">#</a> 5.2 分布式事务的方式</h2>
<p>在分布式系统中，要实现分布式事务，无外乎那几种解决方案。</p>
<h4 id="一-两阶段提交2pc需要数据库产商的支持java组件有atomikos等"><a class="markdownIt-Anchor" href="#一-两阶段提交2pc需要数据库产商的支持java组件有atomikos等">#</a> 一、两阶段提交（2PC）需要数据库产商的支持，java 组件有 atomikos 等。</h4>
<p>两阶段提交（Two-phase Commit，2PC），通过引入协调者（Coordinator）来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。</p>
<h5 id="1-准备阶段"><a class="markdownIt-Anchor" href="#1-准备阶段">#</a> 1、准备阶段</h5>
<p>协调者询问参与者事务是否执行成功，参与者发回事务执行结果。</p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/852.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/852.png" class=""></p>
<h5 id="2-提交阶段"><a class="markdownIt-Anchor" href="#2-提交阶段">#</a> 2、提交阶段</h5>
<p>如果事务在每个参与者上都执行成功，事务协调者发送通知让参与者提交事务；否则，协调者发送通知让参与者回滚事务。<br>
需要注意的是，在准备阶段，参与者执行了事务，但是还未提交。只有在提交阶段接收到协调者发来的通知后，才进行提交或者回滚。</p>
<p><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/853.png" alt="853"><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/853.png" class=""></p>
<h5 id="存在的问题"><a class="markdownIt-Anchor" href="#存在的问题">#</a> 存在的问题</h5>
<ul>
<li>1 同步阻塞 所有事务参与者在等待其它参与者响应的时候都处于同步阻塞状态，无法进行其它操作。</li>
<li>2 单点问题 协调者在 2PC 中起到非常大的作用，发生故障将会造成很大影响。特别是在阶段二发生故障，所有参与者会一直等待状态，无法完成其它操作。</li>
<li>3 数据不一致 在阶段二，如果协调者只发送了部分 Commit 消息，此时网络发生异常，那么只有部分参与者接收到 Commit 消息，也就是说只有部分参与者提交了事务，使得系统数据不一致。</li>
<li>4 太过保守 任意一个节点失败就会导致整个事务失败，没有完善的容错机制。</li>
</ul>
<h4 id="二-补偿事务tcc-严选阿里蚂蚁金服"><a class="markdownIt-Anchor" href="#二-补偿事务tcc-严选阿里蚂蚁金服">#</a> 二、补偿事务（TCC） 严选，阿里，蚂蚁金服。</h4>
<p>TCC 其实就是采用的补偿机制，其核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。它分为三个阶段：</p>
<ul>
<li>Try 阶段主要是对业务系统做检测及资源预留</li>
<li>Confirm 阶段主要是对业务系统做确认提交，Try 阶段执行成功并开始执行 Confirm 阶段时，默认 - - - Confirm 阶段是不会出错的。即：只要 Try 成功，Confirm 一定成功。</li>
<li>Cancel 阶段主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。</li>
</ul>
<blockquote>
<p>举个例子，假入 Bob 要向 Smith 转账，思路大概是： 我们有一个本地方法，里面依次调用<br>
 1：首先在 Try 阶段，要先调用远程接口把 Smith 和 Bob 的钱给冻结起来。<br>
2：在 Confirm 阶段，执行远程调用的转账的操作，转账成功进行解冻。<br>
3：如果第 2 步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方法 (Cancel)。</p>
</blockquote>
<p>优点： 跟 2PC 比起来，实现以及流程相对简单了一些，但数据的一致性比 2PC 也要差一些<br>
缺点： 缺点还是比较明显的，在 2,3 步中都有可能失败。TCC 属于应用层的一种补偿方式，所以需要程序员在实现的时候多写很多补偿的代码，在一些场景中，一些业务流程可能用 TCC 不太好定义及处理。</p>
<h4 id="三-本地消息表异步确保比如支付宝-微信支付主动查询支付状态对账单的形式"><a class="markdownIt-Anchor" href="#三-本地消息表异步确保比如支付宝-微信支付主动查询支付状态对账单的形式">#</a> 三、本地消息表（异步确保）比如：支付宝、微信支付主动查询支付状态，对账单的形式</h4>
<p>本地消息表与业务数据表处于同一个数据库中，这样就能利用本地事务来保证在对这两个表的操作满足事务特性，并且使用了消息队列来保证最终一致性。</p>
<ul>
<li>在分布式事务操作的一方完成写业务数据的操作之后向本地消息表发送一个消息，本地事务能保证这个消息一定会被写入本地消息表中。</li>
<li>之后将本地消息表中的消息转发到 Kafka 等消息队列中，如果转发成功则将消息从本地消息表中删除，否则继续重新转发。</li>
<li>在分布式事务操作的另一方从消息队列中读取一个消息，并执行消息中的操作。</li>
</ul>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/854.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/854.png" class=""></p>
<blockquote>
<p>优点： 一种非常经典的实现，避免了分布式事务，实现了最终一致性。<br>
缺点： 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。</p>
</blockquote>
<h3 id="四-mq-事务消息-异步场景通用性较强拓展性较高"><a class="markdownIt-Anchor" href="#四-mq-事务消息-异步场景通用性较强拓展性较高">#</a> 四、MQ 事务消息 异步场景，通用性较强，拓展性较高。</h3>
<p>有一些第三方的 MQ 是支持事务消息的，比如 RocketMQ，他们支持事务消息的方式也是类似于采用的二阶段提交，但是市面上一些主流的 MQ 都是不支持事务消息的，比如 Kafka 不支持。<br>
以阿里的 RabbitMQ 中间件为例，其思路大致为：</p>
<ul>
<li>第一阶段 Prepared 消息，会拿到消息的地址。 第二阶段执行本地事务，第三阶段通过第一阶段拿到的地址去访问消息，并修改状态。</li>
<li>也就是说在业务方法内要想消息队列提交两次请求，一次发送消息和一次确认消息。如果确认消息发送失败了 RabbitMQ 会定期扫描消息集群中的事务消息，这时候发现了 Prepared 消息，它会向消息发送者确认，所以生产方需要实现一个 check 接口，RabbitMQ 会根据发送端设置的策略来决定是回滚还是继续发送确认消息。这样就保证了消息发送与本地事务同时成功或同时失败。</li>
</ul>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/855.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/855.png" class=""></p>
<blockquote>
<p>优点： 实现了最终一致性，不需要依赖本地数据库事务。<br>
缺点： 实现难度大，主流 MQ 不支持，RocketMQ 事务消息部分代码也未开源。</p>
</blockquote>
<h3 id="五-总结"><a class="markdownIt-Anchor" href="#五-总结">#</a> 五、总结</h3>
<p>通过本文我们总结并对比了几种分布式分解方案的优缺点，分布式事务本身是一个技术难题，是没有一种完美的方案应对所有场景的，具体还是要根据业务场景去抉择吧。阿里 RocketMQ 去实现的分布式事务，现在也有除了很多分布式事务的协调器，比如 LCN 等，大家可以多去尝试。</p>
<h2 id="53-具体实现"><a class="markdownIt-Anchor" href="#53-具体实现">#</a> 5.3 具体实现</h2>
<p>分布式事务的完整架构图：</p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/856.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/856.png" class=""></p>
<p>美团外卖架构：</p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/857.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/857.png" class=""></p>
<h3 id="531-系统与系统之间的分布式事务问题"><a class="markdownIt-Anchor" href="#531-系统与系统之间的分布式事务问题">#</a> 5.3.1 系统与系统之间的分布式事务问题</h3>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/858.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/858.png" class=""></p>
<h3 id="532-系统间调用过程中事务回滚问题"><a class="markdownIt-Anchor" href="#532-系统间调用过程中事务回滚问题">#</a> 5.3.2 系统间调用过程中事务回滚问题</h3>
<p>创建两个项目 <code>mt_order</code>  和 <code>mt_dispatch</code></p>
<ul>
<li>mt_order</li>
</ul>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8089</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mariadb<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/demo</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> org.mariadb.jdbc.Driver</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">jpa</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">show-sql</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">open-in-view</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">hibernate</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">ddl-auto</span><span class="token punctuation">:</span> update</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">addresses</span><span class="token punctuation">:</span> 10.1.53.166<span class="token punctuation">:</span><span class="token number">5672</span><span class="token punctuation">,</span>10.1.53.166<span class="token punctuation">:</span><span class="token number">5673</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment"># 开启手动 ACK，让程序去控制 MQ 消息的重发、移除和转移</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">publisher-confirm-type</span><span class="token punctuation">:</span> correlated</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">publisher-returns</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">listener</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">simple</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual</pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token key atrule">retry</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启重启</span></pre></td></tr><tr><td data-num="28"></td><td><pre>          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment">#最大重试次数</span></pre></td></tr><tr><td data-num="29"></td><td><pre>          <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> 2000ms <span class="token comment">#重试间隔时间</span></pre></td></tr></table></figure><figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-rabbit-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mariadb.jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mariadb-java-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Entity</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"`order`"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Id</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> orderContent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">OrderRepository</span> orderRepository<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">// 1. 订单信息 ---- 插入订单数据库，订单数据库事务</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        orderRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 2. 通过 http 接口发送订单消息到运单系统</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token function">dispatchHttpApi</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"success"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"订单创建失败，原因是运单接口调用失败！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="20"></td><td><pre>     * 将订单信息发送到运单系统</pre></td></tr><tr><td data-num="21"></td><td><pre>     * @param orderId 订单 ID</pre></td></tr><tr><td data-num="22"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="23"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">dispatchHttpApi</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">SimpleClientHttpRequestFactory</span> factory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleClientHttpRequestFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token comment">// 连接超时 > 3 秒</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        factory<span class="token punctuation">.</span><span class="token function">setConnectTimeout</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// 处理超时 > 2 秒</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        factory<span class="token punctuation">.</span><span class="token function">setReadTimeout</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 发送 http 请求</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://localhost:9000/dispatch/order?orderId="</span> <span class="token operator">+</span> orderId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token class-name">RestTemplate</span> restTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">String</span> result <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul>
<li>mt_dispatch</li>
</ul>
<figure class="highlight xml"><figcaption data-lang="XML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-devtools<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">></span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-rabbit-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>spring-boot-starter-data-jpa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">></span></span>org.mariadb.jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">></span></span>mariadb-java-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">></span></span>runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">></span></span></pre></td></tr></table></figure><figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">server</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>  <span class="token key atrule">datasource</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> root</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mariadb<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/demo</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> org.mariadb.jdbc.Driver</pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token key atrule">jpa</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">show-sql</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">open-in-view</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">hibernate</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">ddl-auto</span><span class="token punctuation">:</span> update</pre></td></tr><tr><td data-num="15"></td><td><pre>  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">addresses</span><span class="token punctuation">:</span> 10.1.53.166<span class="token punctuation">:</span><span class="token number">5672</span><span class="token punctuation">,</span>10.1.53.166<span class="token punctuation">:</span><span class="token number">5673</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> admin</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> /</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment"># 开启手动 ACK，让程序去控制 MQ 消息的重发、移除和转移</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">listener</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">simple</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual</pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token key atrule">retry</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启重启</span></pre></td></tr><tr><td data-num="26"></td><td><pre>          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">10</span> <span class="token comment">#最大重试次数</span></pre></td></tr><tr><td data-num="27"></td><td><pre>          <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> 2000ms <span class="token comment">#重试间隔时间</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Entity</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Dispatcher</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Id</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> orderId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> orderContent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DispatchRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Dispatcher</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DispatchService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">DispatchRepository</span> dispatchRepository<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">Dispatcher</span> dispatcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dispatcher</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"买了一栋别墅"</span><span class="token punctuation">,</span> <span class="token number">666</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">Dispatcher</span> result <span class="token operator">=</span> dispatchRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"运单创建失败！原因【操作数据库失败】"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 <code>mt_order</code>  中添加单元测试，模拟创建订单， <code>mt_dispatch</code>  开启 <code>debug</code>  模式，并打断点在 <code>DispatchService</code>  中的 <code>dispatch</code>  方法。</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Test</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">void</span> <span class="token function">orderCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token class-name">String</span> orderId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    order<span class="token punctuation">.</span><span class="token function">setOrderContent</span><span class="token punctuation">(</span><span class="token string">"买了一栋别墅"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    orderService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"订单创建成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>【测试结果】订单系统因为设置了处理超时时间 <code>2s</code> ，超过了之后数据会进行回滚，而运单系统则继续将数据插入到数据库中。订单系统出现异常，会进行回滚，而运单系统不会。</p>
<p>【结论】订单系统的 Transactional 只能控制自己服务的事务，不能控制其他服务的事务，从而引起分布式事务问题。</p>
<h3 id="533-基于mq的分布式事务整体设计思路"><a class="markdownIt-Anchor" href="#533-基于mq的分布式事务整体设计思路">#</a> 5.3.3 基于 MQ 的分布式事务整体设计思路</h3>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/859.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/859.png" class=""></p>
<h3 id="534-基于mq的分布式事务消息的可靠生产问题"><a class="markdownIt-Anchor" href="#534-基于mq的分布式事务消息的可靠生产问题">#</a> 5.3.4 基于 MQ 的分布式事务消息的可靠生产问题</h3>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/860.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/860.png" class=""></p>
<p>如果这个时候 MQ 服务器出现了异常和故障，那么消息是无法获取到回执信息。怎么解决呢？</p>
<h3 id="535-基于mq的分布式事务消息的可靠生产问题-定时重发"><a class="markdownIt-Anchor" href="#535-基于mq的分布式事务消息的可靠生产问题-定时重发">#</a> 5.3.5 基于 MQ 的分布式事务消息的可靠生产问题 - 定时重发</h3>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/861.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/861.png" class=""></p>
<p>生产者 <code>mt_order</code> yml 配置开启发送确定机制</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment"># 开启手动 ACK，让程序去控制 MQ 消息的重发、移除和转移</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">publisher-confirm-type</span><span class="token punctuation">:</span> correlated <span class="token comment">#消息发送确认机制</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">publisher-returns</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启消息回执</span></pre></td></tr></table></figure><p>创建一个订单消息冗余表，来保证消息的可靠性。</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Entity</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@Data</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@AllArgsConstructor</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@NoArgsConstructor</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMessage</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Id</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> userId<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> orderContent<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">LocalDateTime</span> createTime<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span> <span class="token comment">// 消息发送成功状态，是否已被 rabbitmq 接收。</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建 repository，根据 <code>订单id</code>  修改订单消息冗余表的状态</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderMessageRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderMessage</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token annotation punctuation">@Transactional</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Modifying</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"update order_message set status = ?1 where id = ?2"</span><span class="token punctuation">,</span> nativeQuery <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token class-name">Integer</span> <span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建 service</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMessageService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">OrderMessageRepository</span> orderMessageRepository<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token comment">// 将订单数据保存到订单消息冗余表中。消息状态默认为 0，未消费</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveLocalMessage</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token class-name">OrderMessage</span> orderMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderMessage</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getOrderContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> order<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        orderMessageRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>orderMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建 MQ 发送消息以及发送成功后的确认回调处理。</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMQService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">RabbitTemplate</span> rabbitTemplate<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">OrderMessageRepository</span> orderMessageRepository<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="11"></td><td><pre>     * 发布者确认的回调。</pre></td></tr><tr><td data-num="12"></td><td><pre>     * @PostConstruct 该注解用来修饰一个非静态的 void () 方法，被该注解修饰的方法会在服务器加载 Servlet 的时候运行，并且只会被运行一次。</pre></td></tr><tr><td data-num="13"></td><td><pre>     * @param correlationData 回调的相关数据。</pre></td></tr><tr><td data-num="14"></td><td><pre>     * @param ack             ack 为真，nack 为假</pre></td></tr><tr><td data-num="15"></td><td><pre>     * @param cause           一个可选的原因，用于 nack，如果可用，否则为空。</pre></td></tr><tr><td data-num="16"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token annotation punctuation">@PostConstruct</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">regCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token comment">// 消息发送成功以后，给生产者的消息回执，来确保生产者的可靠性</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>correlationData<span class="token punctuation">,</span> ack<span class="token punctuation">,</span> cause<span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"cause: "</span> <span class="token operator">+</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token comment">// 如果 ack 为 true 代表消息已经收到</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token class-name">String</span> orderId <span class="token operator">=</span> correlationData<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"MQ队列应答失败，orderId是："</span> <span class="token operator">+</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                <span class="token class-name">Integer</span> count <span class="token operator">=</span> orderMessageRepository<span class="token punctuation">.</span><span class="token function">updateStatus</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"本地消息状态修改成功，消息成功投递到消息队列中..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"本地消息状态修改失败，出现异常："</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"order_fanout_exchange"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">objectToJson</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>    </pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token class-name">OrderMessage</span> orderMessage<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        rabbitTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">"order_fanout_exchange"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">objectToJson</span><span class="token punctuation">(</span>orderMessage<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">CorrelationData</span><span class="token punctuation">(</span>orderMessage<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>JSON 序列化工具类，这里使用的是 <code>jackson</code></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * 当前类用于将某个特定的对象转换为 JSON 对象，或者将 JSON 对象转换为某个特定的对象</pre></td></tr><tr><td data-num="3"></td><td><pre> */</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JsonUtil</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ObjectMapper</span> mapper<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setMapper</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper</span> mapper<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span>mapper <span class="token operator">=</span> mapper<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">String</span> <span class="token function">objectToJson</span><span class="token punctuation">(</span><span class="token class-name">T</span> o<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token keyword">return</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> <span class="token class-name">T</span> <span class="token function">jsonToObject</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span>  <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">></span></span> tr<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token class-name">T</span> o <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span>mapper<span class="token punctuation">.</span><span class="token function">readValue</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> tr<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token keyword">return</span> o<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建一个定时任务，每隔一段时间，检查有没有发送失败的消息，然后重新将消息发送到 MQ 中</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Slf4j</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token annotation punctuation">@EnableScheduling</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token annotation punctuation">@Component</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskService</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">OrderMessageService</span> orderMessageService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">OrderMQService</span> orderMQService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">"0 */1 * * * ?"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 把消息为 0 的状态消息查询出来，重新投递到 MQ 中。</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderMessage</span><span class="token punctuation">></span></span> list <span class="token operator">=</span> orderMessageService<span class="token punctuation">.</span><span class="token function">findByStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"检查未发送的消息，进行重新发送，需要重发的数量 = "</span> <span class="token operator">+</span> list<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">// 3. 通过 http 接口发送订单消息到运单系统</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>order <span class="token operator">-></span> orderMQService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>创建控制器，以便开启 debug 模式测试</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@RestController</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">MQOrderService</span> mqOrderService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/test"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">String</span> orderId <span class="token operator">=</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        order<span class="token punctuation">.</span><span class="token function">setOrderContent</span><span class="token punctuation">(</span><span class="token string">"买了一栋别墅"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        order<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">666</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        order<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>        mqOrderService<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"订单创建成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>在 rabbitmq Web 控制界面创建 <code>fanout模式</code> 交换机 <code>order_fanout_exchange</code>  以及绑定消息队列 <code>order.queue</code> 。</p>
<p>【测试】开启 debug 模式，浏览器访问 <code>http://ip:8089/test</code></p>
<h3 id="536-基于mq的分布式事务消息的可靠消费"><a class="markdownIt-Anchor" href="#536-基于mq的分布式事务消息的可靠消费">#</a> 5.3.6 基于 MQ 的分布式事务消息的可靠消费</h3>
<p><strong>在消息过程中，出现了故障，默认会进行重发，触发 rabbitmq 的重试机制，而重试机制会引发死循环。</strong></p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/862.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/862.png" class=""></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">/**</pre></td></tr><tr><td data-num="2"></td><td><pre> * @ClassName OrderMQConsumer</pre></td></tr><tr><td data-num="3"></td><td><pre> * @Description 订单 MQ 消息 消费</pre></td></tr><tr><td data-num="4"></td><td><pre> * @Author zzm</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Data 2021/5/24 9:59</pre></td></tr><tr><td data-num="6"></td><td><pre> * @Version 1.0</pre></td></tr><tr><td data-num="7"></td><td><pre> */</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMQConsumer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">DispatchService</span> dispatchService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 解决消息重试的集中方案：</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">//1. 控制重发的次数</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token comment">//2.try + catch + 手动 ack</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token comment">//3.try + catch + 手动 ack + 死信队列 + 人工干预</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"order.queue"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">messageConsumer</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderMsg<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token class-name">AmqpHeaders</span><span class="token punctuation">.</span>DELIVERY_TAG<span class="token punctuation">)</span> <span class="token keyword">long</span> tag<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">// 1. 获取消息队列的消息</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到MQ的消息是："</span> <span class="token operator">+</span> orderMsg <span class="token operator">+</span> <span class="token string">"，count = "</span> <span class="token operator">+</span> count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 2. 获取订单服务的消息</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">jsonToObject</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">String</span> orderId <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"订单ID = "</span> <span class="token operator">+</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token keyword">int</span> a <span class="token operator">=</span><span class="token number">1</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// 3. 派单处理</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        dispatchService<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>控制消息重发的次数</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">spring</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="3"></td><td><pre>    <span class="token comment"># 开启手动 ACK，让程序去控制 MQ 消息的重发、移除和转移</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token key atrule">listener</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>      <span class="token key atrule">simple</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual <span class="token comment"># 默认为 none，自动进行 ack，会把消息进行移除或转移到死信队列；manual 表示进行手动确认</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token key atrule">retry</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="8"></td><td><pre>          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment">#开启重启</span></pre></td></tr><tr><td data-num="9"></td><td><pre>          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment">#最大重试次数</span></pre></td></tr><tr><td data-num="10"></td><td><pre>          <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> 2000ms <span class="token comment">#重试间隔时间</span></pre></td></tr></table></figure><h3 id="537-基于mq的分布式事务消息的消息重发"><a class="markdownIt-Anchor" href="#537-基于mq的分布式事务消息的消息重发">#</a> 5.3.7 基于 MQ 的分布式事务消息的消息重发</h3>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/863.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/863.png" class=""></p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderMQConsumer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">DispatchService</span> dispatchService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 解决消息重试的集中方案：</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">//1. 控制重发的次数</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">//2.try + catch + 手动 ack</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">//3.try + catch + 手动 ack + 死信队列 + 人工干预</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"order.queue"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">messageConsumer</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderMsg<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token class-name">AmqpHeaders</span><span class="token punctuation">.</span>DELIVERY_TAG<span class="token punctuation">)</span> <span class="token keyword">long</span> tag<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 1. 获取消息队列的消息</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"收到MQ的消息是："</span> <span class="token operator">+</span> orderMsg <span class="token operator">+</span> <span class="token string">"，count = "</span> <span class="token operator">+</span> count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 2. 获取订单服务的消息</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">jsonToObject</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token comment">// 3. 获取订单 id</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token class-name">String</span> orderId <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"订单ID = "</span> <span class="token operator">+</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment">//        int a =1/0;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// 4. 派单处理</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            dispatchService<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>            <span class="token comment">// 5. 手动 ack 告诉 MQ 消息已经正常消费</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token comment">// 如果出现异常的情况下，根据实际的情况去进行重发</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token comment">// 重发一次后，丢失，还是记录，存库根据自己的业务场景去决定</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token comment">// 参数 1：消息的 tag   参数 2：false 是否多条处理</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token comment">// 参数 3： requeue 是否重发，false 不会重发，会把消息转移到死信队列中；true 的话会进行死循环的重发，建议如果使用 true 的话，不要加 try/catch 否则就会造成死循环。</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote>
<p>如果使用的是 try + catch + 手动 ack，之前的控制重试次数机制就会失效</p>
</blockquote>
<h3 id="538-基于mq的分布式事务消息的死信队列消息转移-人工处理"><a class="markdownIt-Anchor" href="#538-基于mq的分布式事务消息的死信队列消息转移-人工处理">#</a> 5.3.8 基于 MQ 的分布式事务消息的死信队列消息转移 + 人工处理</h3>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/864.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/864.png" class=""></p>
<p><strong>如果死信队列报错就进行人工处理</strong></p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/865.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/865.png" class=""></p>
<p>新建 rabbitmq 配置类 <code>RabbitMQConfiguration</code> ，定义订单交换机、队列，以及死信交换机和队列，并完成队列和死信队列的绑定。</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Configuration</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitMQConfiguration</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/**</pre></td></tr><tr><td data-num="5"></td><td><pre>     * 声明注册 fanout 模式的交换机，作为死信交换机</pre></td></tr><tr><td data-num="6"></td><td><pre>     * @return FanoutExchange</pre></td></tr><tr><td data-num="7"></td><td><pre>     */</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">deadExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token string">"dead_order_fanout_exchange"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 声明死信队列</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deadOrderQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"dead.order.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">// 完成绑定关系（队列和交换机）</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingDeadOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">deadOrderQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">deadExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FanoutExchange</span> <span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FanoutExchange</span><span class="token punctuation">(</span><span class="token string">"order_fanout_exchange"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">orderQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">></span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-exchange"</span><span class="token punctuation">,</span> <span class="token string">"dead_order_fanout_exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"order.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>    <span class="token annotation punctuation">@Bean</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">bindingOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">orderQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">fanoutExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="42"></td><td><pre></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>消费者根据订单消费类，复制出来一个死信队列消费处理，失败后的处理根据业务场景决定。</p>
<figure class="highlight java"><figcaption data-lang="java"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token annotation punctuation">@Service</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DeadMQConsumer</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token annotation punctuation">@Autowired</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">DispatchService</span> dispatchService<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token comment">// 解决消息重试的集中方案：</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token comment">//1. 控制重发的次数</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">//2.try + catch + 手动 ack</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token comment">//3.try + catch + 手动 ack + 死信队列 + 人工干预</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token annotation punctuation">@RabbitListener</span><span class="token punctuation">(</span>queues <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">"dead.order.queue"</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">messageConsumer</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderMsg<span class="token punctuation">,</span> <span class="token class-name">Channel</span> channel<span class="token punctuation">,</span> <span class="token class-name">CorrelationData</span> correlationData<span class="token punctuation">,</span> <span class="token annotation punctuation">@Header</span><span class="token punctuation">(</span><span class="token class-name">AmqpHeaders</span><span class="token punctuation">.</span>DELIVERY_TAG<span class="token punctuation">)</span> <span class="token keyword">long</span> tag<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token comment">// 1. 获取消息队列的消息</span></pre></td></tr><tr><td data-num="17"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"死信队列收到MQ的消息是："</span> <span class="token operator">+</span> orderMsg <span class="token operator">+</span> <span class="token string">"，count = "</span> <span class="token operator">+</span> count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 2. 获取订单服务的消息</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token class-name">JsonUtil</span><span class="token punctuation">.</span><span class="token function">jsonToObject</span><span class="token punctuation">(</span>orderMsg<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TypeReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Order</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token comment">// 3. 获取订单 id</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token class-name">String</span> orderId <span class="token operator">=</span> order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"订单ID = "</span> <span class="token operator">+</span> orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token comment">// 4. 派单处理</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            dispatchService<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            <span class="token comment">// 5. 手动 ack 告诉 MQ 消息已经正常消费</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">basicAck</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"人工干预"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"发送短信预警"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"把消息转移到别的存储DB"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            channel<span class="token punctuation">.</span><span class="token function">basicNack</span><span class="token punctuation">(</span>tag<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote>
<p>由于  <code>订单队列</code> 和 <code>死信队列</code>  都对 运单数据进行插入，所以要考虑到数据幂等性（数据的一致性），可以将运单表的订单 ID <code>orderId</code>  设置唯一约束，这个方法会损耗数据库的一些资源；另一种办法就是使用分布式锁。</p>
</blockquote>
<p>整个流程：生产者推送一条消息过来，为了保证可靠生产，使用消息冗余的机制，来保证消息投递的可靠性；</p>
<p>消费者监听 <code>order.queue</code>  队列，接收消费过程中出现异常故障，将消息转移到死信队列中。</p>
<p>消费者监听死信队列 <code>dead.order.queue</code> ，接收到以后，消费后正常处理，如果消费过程中，出现异常故障，则进行 <code>人工干预</code> 、 <code>发送短信预警</code> 或者 <code>把消息转移到别的存储DB</code> ，最后把消息进行移除。</p>
<h2 id="6-其他信息"><a class="markdownIt-Anchor" href="#6-其他信息">#</a> 6、其他信息</h2>
<p>SpringBoot RabbitMq 详细配置信息</p>
<figure class="highlight yml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="2"></td><td><pre>    <span class="token key atrule">addresses</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">6605</span><span class="token punctuation">,</span>127.0.0.1<span class="token punctuation">:</span><span class="token number">6606</span><span class="token punctuation">,</span>127.0.0.1<span class="token punctuation">:</span><span class="token number">6705</span> <span class="token comment">#指定 client 连接到的 server 的地址，多个以逗号分隔 (优先取 addresses，然后再取 host)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#    port:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">## 集群配置 addresses 之间用逗号隔开</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment"># addresses: ip:port,ip:port</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">password</span><span class="token punctuation">:</span> admin</pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">username</span><span class="token punctuation">:</span> <span class="token number">123456</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">virtual-host</span><span class="token punctuation">:</span> / <span class="token comment"># 连接到 rabbitMQ 的 vhost</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">requested-heartbeat</span><span class="token punctuation">:</span> <span class="token comment">#指定心跳超时，单位秒，0 为不指定；默认 60s</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">publisher-confirms</span><span class="token punctuation">:</span> <span class="token comment">#是否启用 发布确认</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">publisher-reurns</span><span class="token punctuation">:</span> <span class="token comment"># 是否启用发布返回</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token key atrule">connection-timeout</span><span class="token punctuation">:</span> <span class="token comment">#连接超时，单位毫秒，0 表示无穷大，不超时</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">cache</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token key atrule">channel.size</span><span class="token punctuation">:</span> <span class="token comment"># 缓存中保持的 channel 数量</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token key atrule">channel.checkout-timeout</span><span class="token punctuation">:</span> <span class="token comment"># 当缓存数量被设置时，从缓存中获取一个 channel 的超时时间，单位毫秒；如果为 0，则总是创建一个新 channel</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">connection.size</span><span class="token punctuation">:</span> <span class="token comment"># 缓存的连接数，只有是 CONNECTION 模式时生效</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">connection.mode</span><span class="token punctuation">:</span> <span class="token comment"># 连接工厂缓存模式：CHANNEL 和 CONNECTION</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">listener</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token key atrule">simple.auto-startup</span><span class="token punctuation">:</span> <span class="token comment"># 是否启动时自动启动容器</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token key atrule">simple.acknowledge-mode</span><span class="token punctuation">:</span> <span class="token comment"># 表示消息确认方式，其有三种配置方式，分别是 none、manual 和 auto；默认 auto</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">simple.concurrency</span><span class="token punctuation">:</span> <span class="token comment"># 最小的消费者数量</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">simple.max-concurrency</span><span class="token punctuation">:</span> <span class="token comment"># 最大的消费者数量</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token key atrule">simple.prefetch</span><span class="token punctuation">:</span> <span class="token comment"># 指定一个请求能处理多少个消息，如果有事务的话，必须大于等于 transaction 数量.</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token key atrule">simple.transaction-size</span><span class="token punctuation">:</span> <span class="token comment"># 指定一个事务处理的消息数量，最好是小于等于 prefetch 的数量.</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token key atrule">simple.default-requeue-rejected</span><span class="token punctuation">:</span> <span class="token comment"># 决定被拒绝的消息是否重新入队；默认是 true（与参数 acknowledge-mode 有关系）</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token key atrule">simple.idle-event-interval</span><span class="token punctuation">:</span> <span class="token comment"># 多少长时间发布空闲容器时间，单位毫秒</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token key atrule">simple.retry.enabled</span><span class="token punctuation">:</span> <span class="token comment"># 监听重试是否可用</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token key atrule">simple.retry.max-attempts</span><span class="token punctuation">:</span> <span class="token comment"># 最大重试次数</span></pre></td></tr><tr><td data-num="29"></td><td><pre>      <span class="token key atrule">simple.retry.initial-interval</span><span class="token punctuation">:</span> <span class="token comment"># 第一次和第二次尝试发布或传递消息之间的间隔</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token key atrule">simple.retry.multiplier</span><span class="token punctuation">:</span> <span class="token comment"># 应用于上一重试间隔的乘数</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token key atrule">simple.retry.max-interval</span><span class="token punctuation">:</span> <span class="token comment"># 最大重试时间间隔</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">simple.retry.stateless</span><span class="token punctuation">:</span> <span class="token comment"># 重试是有状态 or 无状态</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token key atrule">template</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="34"></td><td><pre>      <span class="token key atrule">mandatory</span><span class="token punctuation">:</span> <span class="token comment"># 启用强制信息；默认 false</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token key atrule">receive-timeout</span><span class="token punctuation">:</span> <span class="token comment"># receive () 操作的超时时间</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token key atrule">reply-timeout</span><span class="token punctuation">:</span> <span class="token comment"># sendAndReceive () 操作的超时时间</span></pre></td></tr><tr><td data-num="37"></td><td><pre>      <span class="token key atrule">retry.enabled</span><span class="token punctuation">:</span> <span class="token comment"># 发送重试是否可用</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token key atrule">retry.max-attempts</span><span class="token punctuation">:</span> <span class="token comment"># 最大重试次数</span></pre></td></tr><tr><td data-num="39"></td><td><pre>      <span class="token key atrule">retry.initial-interval</span><span class="token punctuation">:</span> <span class="token comment"># 第一次和第二次尝试发布或传递消息之间的间隔</span></pre></td></tr><tr><td data-num="40"></td><td><pre>      <span class="token key atrule">retry.multiplier</span><span class="token punctuation">:</span> <span class="token comment"># 应用于上一重试间隔的乘数</span></pre></td></tr><tr><td data-num="41"></td><td><pre>      <span class="token key atrule">retry.max-interval</span><span class="token punctuation">:</span> <span class="token comment">#最大重试时间间隔</span></pre></td></tr></table></figure><blockquote>
<p>注：相关配置很多，大家只需要关注一些常用的配置即可</p>
</blockquote>
<ul>
<li>对于发送方而言，需要做以下配置：<br>
1 配置 CachingConnectionFactory<br>
2 配置 Exchange/Queue/Binding<br>
3 配置 RabbitAdmin 创建上一步的 Exchange/Queue/Binding<br>
4 配置 RabbitTemplate 用于发送消息，RabbitTemplate 通过 CachingConnectionFactory 获取到 Connection，然后想指定 Exchange 发送</li>
<li>对于消费方而言，需要做以下配置：<br>
1 配置 CachingConnectionFactory<br>
2 配置 Exchange/Queue/Binding<br>
3 配置 RabbitAdmin 创建上一步的 Exchange/Queue/Binding<br>
4 配置 RabbitListenerContainerFactory<br>
5 配置<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JhYmJpdExpc3RlbmVy"> @RabbitListener</span>/<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JhYmJpdEhhbmRsZXI=">@RabbitHandler</span> 用于接收消息<br>
在默认情况下主要的配置如下：</li>
</ul>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/866.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/866.png" class=""></p>
<p>Spring AMQP 的主要对象:</p>
<p><img data-src="RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/867.png" alt=""><img data-src="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/867.png" class=""></p>

      <div class="tags">
          <a href="/tags/RabbitMQ/" rel="tag"><i class="ic i-tag"></i> RabbitMQ</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2021-06-22 16:42:30" itemprop="dateModified" datetime="2021-06-22T16:42:30+08:00">2021-06-22</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> 赞赏</button>
  <p>请我喝[茶]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="失心耀 微信支付">
        <p>微信支付</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="失心耀 支付宝">
        <p>支付宝</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="失心耀 贝宝">
        <p>贝宝</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>失心耀 <i class="ic i-at"><em>@</em></i>失心耀的博客
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://example.com/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" title="RabbitMQ 高级特性">http://example.com/RabbitMQ-高级特性/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/RabbitMQ-%E5%85%A5%E9%97%A8%E5%8F%8A%E4%BD%BF%E7%94%A8/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicliierfjj20zk0m8npd.jpg" title="RabbitMQ 入门及使用">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> Rabbitmq</span>
  <h3>RabbitMQ 入门及使用</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/redis/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicivghyooj20zk0m8dir.jpg" title="Redis初步学习">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> Redis</span>
  <h3>Redis初步学习</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-rabbitmq%E9%AB%98%E7%BA%A7-%E8%BF%87%E6%9C%9F%E6%97%B6%E9%97%B4ttl"><span class="toc-number">1.</span> <span class="toc-text"> 1. RabbitMQ 高级 - 过期时间 TTL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#11-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.1.</span> <span class="toc-text"> 1.1 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-%E8%AE%BE%E7%BD%AE%E9%98%9F%E5%88%97ttl"><span class="toc-number">1.2.</span> <span class="toc-text"> 1.2 设置队列 TTL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-%E8%AE%BE%E7%BD%AE%E6%B6%88%E6%81%AFttl"><span class="toc-number">1.3.</span> <span class="toc-text"> 1.3 设置消息 TTL</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-rabbitmq%E9%AB%98%E7%BA%A7-%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97"><span class="toc-number">2.</span> <span class="toc-text"> 2. RabbitMQ 高级 - 死信队列</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#21-%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text"> 2.1 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text"> 2.2 实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-%E9%98%9F%E5%88%97%E8%BE%BE%E5%88%B0%E6%9C%80%E5%A4%A7%E6%8E%A5%E6%94%B6%E9%95%BF%E5%BA%A6"><span class="toc-number">2.3.</span> <span class="toc-text"> 2.3 队列达到最大接收长度</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3rabbitmq%E9%AB%98%E7%BA%A7-%E5%86%85%E5%AD%98%E7%A3%81%E7%9B%98%E7%9A%84%E7%9B%91%E6%8E%A7"><span class="toc-number">3.</span> <span class="toc-text"> 3.RabbitMQ 高级 - 内存磁盘的监控</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#31-rabbitmq%E7%9A%84%E5%86%85%E5%AD%98%E8%AD%A6%E5%91%8A"><span class="toc-number">3.1.</span> <span class="toc-text"> 3.1 RabbitMQ 的内存警告</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#32-rabbitmq%E7%9A%84%E5%86%85%E5%AD%98%E6%8E%A7%E5%88%B6"><span class="toc-number">3.2.</span> <span class="toc-text"> 3.2 RabbitMQ 的内存控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#321-%E5%91%BD%E4%BB%A4%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.1.</span> <span class="toc-text"> 3.2.1 命令的方式：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#322-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%96%B9%E5%BC%8F-rabbitmqconf"><span class="toc-number">3.2.2.</span> <span class="toc-text"> 3.2.2 配置文件方式 rabbitmq.conf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#33-rabbitmq%E7%9A%84%E5%86%85%E5%AD%98%E6%8D%A2%E9%A1%B5"><span class="toc-number">3.3.</span> <span class="toc-text"> 3.3 RabbitMQ 的内存换页</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#34-rabbitmq%E7%9A%84%E7%A3%81%E7%9B%98%E9%A2%84%E8%AD%A6"><span class="toc-number">3.4.</span> <span class="toc-text"> 3.4 RabbitMQ 的磁盘预警</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%E6%96%B9%E5%BC%8F%E4%BF%AE%E6%94%B9%E5%A6%82%E4%B8%8B"><span class="toc-number">3.4.1.</span> <span class="toc-text"> 通过命令方式修改如下：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%85%8D%E7%BD%AE%E5%A6%82%E4%B8%8B"><span class="toc-number">3.4.2.</span> <span class="toc-text"> 通过配置文件配置如下：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-rabbitmq-%E9%AB%98%E7%BA%A7-%E9%9B%86%E7%BE%A4"><span class="toc-number">4.</span> <span class="toc-text"> 4. RabbitMQ - 高级 - 集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#41-rabbitmq-%E9%9B%86%E7%BE%A4"><span class="toc-number">4.1.</span> <span class="toc-text"> 4.1 RabbitMQ 集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#42-%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">4.2.</span> <span class="toc-text"> 4.2 集群搭建</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#43-%E5%8D%95%E6%9C%BA%E5%A4%9A%E5%AE%9E%E4%BE%8B%E6%90%AD%E5%BB%BA"><span class="toc-number">4.3.</span> <span class="toc-text"> 4.3 单机多实例搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#431-%E7%AC%AC%E4%B8%80%E6%AD%A5%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%B8%80%E4%B8%AA%E8%8A%82%E7%82%B9rabbit-1"><span class="toc-number">4.3.1.</span> <span class="toc-text"> 4.3.1 第一步：启动第一个节点 rabbit-1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#432-%E5%90%AF%E5%8A%A8%E7%AC%AC%E4%BA%8C%E4%B8%AA%E8%8A%82%E7%82%B9rabbit-2"><span class="toc-number">4.3.2.</span> <span class="toc-text"> 4.3.2 启动第二个节点 rabbit-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#433-%E9%AA%8C%E8%AF%81%E5%90%AF%E5%8A%A8-ps-auxgrep-rabbitmq"><span class="toc-number">4.3.3.</span> <span class="toc-text"> 4.3.3 验证启动 “ps aux|grep rabbitmq”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#434-rabbit-1%E6%93%8D%E4%BD%9C%E4%BD%9C%E4%B8%BA%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">4.3.4.</span> <span class="toc-text"> 4.3.4 rabbit-1 操作作为主节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#435-rabbit2%E6%93%8D%E4%BD%9C%E4%B8%BA%E4%BB%8E%E8%8A%82%E7%82%B9"><span class="toc-number">4.3.5.</span> <span class="toc-text"> 4.3.5 rabbit2 操作为从节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#436-%E9%AA%8C%E8%AF%81%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">4.3.6.</span> <span class="toc-text"> 4.3.6 验证集群状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#437-web%E7%9B%91%E6%8E%A7"><span class="toc-number">4.3.7.</span> <span class="toc-text"> 4.3.7 Web 监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#438-%E5%B0%8F%E7%BB%93"><span class="toc-number">4.3.8.</span> <span class="toc-text"> 4.3.8 小结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-rabbitmq-%E9%AB%98%E7%BA%A7-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">5.</span> <span class="toc-text"> 5. RabbitMQ - 高级 - 分布式事务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#51-%E7%AE%80%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text"> 5.1 简述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#52-%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">5.2.</span> <span class="toc-text"> 5.2 分布式事务的方式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80-%E4%B8%A4%E9%98%B6%E6%AE%B5%E6%8F%90%E4%BA%A42pc%E9%9C%80%E8%A6%81%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%A7%E5%95%86%E7%9A%84%E6%94%AF%E6%8C%81java%E7%BB%84%E4%BB%B6%E6%9C%89atomikos%E7%AD%89"><span class="toc-number">5.2.0.1.</span> <span class="toc-text"> 一、两阶段提交（2PC）需要数据库产商的支持，java 组件有 atomikos 等。</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-%E5%87%86%E5%A4%87%E9%98%B6%E6%AE%B5"><span class="toc-number">5.2.0.1.1.</span> <span class="toc-text"> 1、准备阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-%E6%8F%90%E4%BA%A4%E9%98%B6%E6%AE%B5"><span class="toc-number">5.2.0.1.2.</span> <span class="toc-text"> 2、提交阶段</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">5.2.0.1.3.</span> <span class="toc-text"> 存在的问题</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%8C-%E8%A1%A5%E5%81%BF%E4%BA%8B%E5%8A%A1tcc-%E4%B8%A5%E9%80%89%E9%98%BF%E9%87%8C%E8%9A%82%E8%9A%81%E9%87%91%E6%9C%8D"><span class="toc-number">5.2.0.2.</span> <span class="toc-text"> 二、补偿事务（TCC） 严选，阿里，蚂蚁金服。</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%89-%E6%9C%AC%E5%9C%B0%E6%B6%88%E6%81%AF%E8%A1%A8%E5%BC%82%E6%AD%A5%E7%A1%AE%E4%BF%9D%E6%AF%94%E5%A6%82%E6%94%AF%E4%BB%98%E5%AE%9D-%E5%BE%AE%E4%BF%A1%E6%94%AF%E4%BB%98%E4%B8%BB%E5%8A%A8%E6%9F%A5%E8%AF%A2%E6%94%AF%E4%BB%98%E7%8A%B6%E6%80%81%E5%AF%B9%E8%B4%A6%E5%8D%95%E7%9A%84%E5%BD%A2%E5%BC%8F"><span class="toc-number">5.2.0.3.</span> <span class="toc-text"> 三、本地消息表（异步确保）比如：支付宝、微信支付主动查询支付状态，对账单的形式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B-mq-%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF-%E5%BC%82%E6%AD%A5%E5%9C%BA%E6%99%AF%E9%80%9A%E7%94%A8%E6%80%A7%E8%BE%83%E5%BC%BA%E6%8B%93%E5%B1%95%E6%80%A7%E8%BE%83%E9%AB%98"><span class="toc-number">5.2.1.</span> <span class="toc-text"> 四、MQ 事务消息 异步场景，通用性较强，拓展性较高。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%94-%E6%80%BB%E7%BB%93"><span class="toc-number">5.2.2.</span> <span class="toc-text"> 五、总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#53-%E5%85%B7%E4%BD%93%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.3.</span> <span class="toc-text"> 5.3 具体实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#531-%E7%B3%BB%E7%BB%9F%E4%B8%8E%E7%B3%BB%E7%BB%9F%E4%B9%8B%E9%97%B4%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98"><span class="toc-number">5.3.1.</span> <span class="toc-text"> 5.3.1 系统与系统之间的分布式事务问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#532-%E7%B3%BB%E7%BB%9F%E9%97%B4%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BA%8B%E5%8A%A1%E5%9B%9E%E6%BB%9A%E9%97%AE%E9%A2%98"><span class="toc-number">5.3.2.</span> <span class="toc-text"> 5.3.2 系统间调用过程中事务回滚问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#533-%E5%9F%BA%E4%BA%8Emq%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1%E6%80%9D%E8%B7%AF"><span class="toc-number">5.3.3.</span> <span class="toc-text"> 5.3.3 基于 MQ 的分布式事务整体设计思路</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#534-%E5%9F%BA%E4%BA%8Emq%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98"><span class="toc-number">5.3.4.</span> <span class="toc-text"> 5.3.4 基于 MQ 的分布式事务消息的可靠生产问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#535-%E5%9F%BA%E4%BA%8Emq%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E7%94%9F%E4%BA%A7%E9%97%AE%E9%A2%98-%E5%AE%9A%E6%97%B6%E9%87%8D%E5%8F%91"><span class="toc-number">5.3.5.</span> <span class="toc-text"> 5.3.5 基于 MQ 的分布式事务消息的可靠生产问题 - 定时重发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#536-%E5%9F%BA%E4%BA%8Emq%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%B6%88%E8%B4%B9"><span class="toc-number">5.3.6.</span> <span class="toc-text"> 5.3.6 基于 MQ 的分布式事务消息的可靠消费</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#537-%E5%9F%BA%E4%BA%8Emq%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E6%B6%88%E6%81%AF%E9%87%8D%E5%8F%91"><span class="toc-number">5.3.7.</span> <span class="toc-text"> 5.3.7 基于 MQ 的分布式事务消息的消息重发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#538-%E5%9F%BA%E4%BA%8Emq%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF%E7%9A%84%E6%AD%BB%E4%BF%A1%E9%98%9F%E5%88%97%E6%B6%88%E6%81%AF%E8%BD%AC%E7%A7%BB-%E4%BA%BA%E5%B7%A5%E5%A4%84%E7%90%86"><span class="toc-number">5.3.8.</span> <span class="toc-text"> 5.3.8 基于 MQ 的分布式事务消息的死信队列消息转移 + 人工处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E5%85%B6%E4%BB%96%E4%BF%A1%E6%81%AF"><span class="toc-number">5.4.</span> <span class="toc-text"> 6、其他信息</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
        <ul>
          <li><a href="/RabbitMQ-%E5%85%A5%E9%97%A8%E5%8F%8A%E4%BD%BF%E7%94%A8/" rel="bookmark" title="RabbitMQ 入门及使用">RabbitMQ 入门及使用</a></li><li class="active"><a href="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" rel="bookmark" title="RabbitMQ 高级特性">RabbitMQ 高级特性</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="失心耀"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">失心耀</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">15</span>
        <span class="name">文章</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">15</span>
        <span class="name">分类</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">12</span>
        <span class="name">标签</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL3p4eS0wMTE2L3p4eS0wMTE2LmdpdGh1Yi5pbw==" title="https:&#x2F;&#x2F;github.com&#x2F;zxy-0116&#x2F;zxy-0116.github.io"><i class="ic i-github"></i></span>
      <span class="exturl item music" data-url="aHR0cHM6Ly9tdXNpYy4xNjMuY29tLyMvdXNlci9ob21lP2lkPTE0NTgyOTk1NTI=" title="https:&#x2F;&#x2F;music.163.com&#x2F;#&#x2F;user&#x2F;home?id&#x3D;1458299552"><i class="ic i-cloud-music"></i></span>
      <span class="exturl item gitee" data-url="aHR0cHM6Ly9naXRlZS5jb20veGlueWFvX2lkaW90" title="https:&#x2F;&#x2F;gitee.com&#x2F;xinyao_idiot"><i class="ic i-address-card"></i></span>
      <span class="exturl item QQ" data-url="aHR0cHM6Ly93cGEucXEuY29tL21zZ3JkP3Y9MyZ1aW49MTAzMTU3NDIxMSZzaXRlPXFxJm1lbnU9eWVz" title="https:&#x2F;&#x2F;wpa.qq.com&#x2F;msgrd?v&#x3D;3&amp;uin&#x3D;1031574211&amp;site&#x3D;qq&amp;menu&#x3D;yes"><i class="ic i-qq"></i></span>
      <span class="exturl item bilibili" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMTEwNjM3ODU=" title="https:&#x2F;&#x2F;space.bilibili.com&#x2F;11063785"><i class="ic i-paper-plane"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

        
  <li class="item">
    <a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a>
  </li>

        
  <li class="item">
    <a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a>
  </li>

  </ul>
    
  <li class="item">
    <a href="/friends/" rel="section"><i class="ic i-heart"></i>好友</a>
  </li>

    
  <li class="item">
    <a href="/links/" rel="section"><i class="ic i-paper-plane"></i>分享</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/RabbitMQ-%E5%85%A5%E9%97%A8%E5%8F%8A%E4%BD%BF%E7%94%A8/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/redis/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>随机文章</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%AE%89%E8%A3%85%E6%95%99%E7%A8%8B/" title="分类于 安装教程">安装教程</a>
</div>

    <span><a href="/Hexo%E5%AE%89%E8%A3%85%E8%BF%87%E7%A8%8B/" title="Hexo安装过程">Hexo安装过程</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/skill/" title="分类于 计算机学习">计算机学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/Redis/" title="分类于 Redis">Redis</a>
</div>

    <span><a href="/redis/" title="Redis初步学习">Redis初步学习</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/skill/" title="分类于 计算机学习">计算机学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/ElasticSearch/" title="分类于 ElasticSearch">ElasticSearch</a>
</div>

    <span><a href="/ElasticSearch%E5%88%9D%E6%AD%A5%E5%AD%A6%E4%B9%A0/" title="ElasticSearch初步学习">ElasticSearch初步学习</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/Life/" title="分类于 人生经历">人生经历</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Life/%E9%A9%BE%E7%85%A7/" title="分类于 驾照">驾照</a>
<i class="ic i-angle-right"></i>
<a href="/categories/Life/%E9%A9%BE%E7%85%A7/%E7%A7%91%E7%9B%AE%E4%B8%80/" title="分类于 科目一">科目一</a>
</div>

    <span><a href="/%E7%A7%91%E7%9B%AE%E4%B8%80%E7%AC%94%E8%AE%B0/" title="科目一笔记">科目一笔记</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/skill/" title="分类于 计算机学习">计算机学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/SpringBoot/" title="分类于 SpringBoot">SpringBoot</a>
</div>

    <span><a href="/SpringBoot%E7%AC%94%E8%AE%B0%E5%BF%83%E5%BE%97/" title="springboot笔记心得">springboot笔记心得</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/skill/" title="分类于 计算机学习">计算机学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/Rabbitmq/" title="分类于 Rabbitmq">Rabbitmq</a>
</div>

    <span><a href="/RabbitMQ-%E5%85%A5%E9%97%A8%E5%8F%8A%E4%BD%BF%E7%94%A8/" title="RabbitMQ 入门及使用">RabbitMQ 入门及使用</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/skill/" title="分类于 计算机学习">计算机学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/SpringCloud/" title="分类于 SpringCloud">SpringCloud</a>
</div>

    <span><a href="/SpringCloud%EF%BC%88%E5%B0%9A%E7%A1%85%E8%B0%B7%EF%BC%89/" title="SpringCloud（尚硅谷）">SpringCloud（尚硅谷）</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/skill/" title="分类于 计算机学习">计算机学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/Git/" title="分类于 Git">Git</a>
</div>

    <span><a href="/Git%E5%8D%8F%E5%90%8C%E4%B8%8E%E6%8F%90%E4%BA%A4%E8%A7%84%E8%8C%83/" title="Git协同与提交规范">Git协同与提交规范</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/skill/" title="分类于 计算机学习">计算机学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E8%BF%90%E7%BB%B4/" title="分类于 运维">运维</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E8%BF%90%E7%BB%B4/Nginx/" title="分类于 Nginx">Nginx</a>
</div>

    <span><a href="/nginx/" title="Nginx初步学习">Nginx初步学习</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/skill/" title="分类于 计算机学习">计算机学习</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/" title="分类于 后端">后端</a>
<i class="ic i-angle-right"></i>
<a href="/categories/skill/%E5%90%8E%E7%AB%AF/Rabbitmq/" title="分类于 Rabbitmq">Rabbitmq</a>
</div>

    <span><a href="/RabbitMQ-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" title="RabbitMQ 高级特性">RabbitMQ 高级特性</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>最新评论</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2021</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">失心耀 @ zxy Shoka</span>
  </div>
  <div class="count">
    <span class="post-meta-item-icon">
      <i class="ic i-chart-area"></i>
    </span>
    <span title="站点总字数">281k 字</span>

    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="ic i-coffee"></i>
    </span>
    <span title="站点阅读时长">4:15</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'RabbitMQ-高级特性/',
    favicon: {
      show: "（●´3｀●）復活成功",
      hide: "(´Д｀)瀏覽器崩潰啦"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
